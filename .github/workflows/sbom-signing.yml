name: SBOM Generation and Signing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Install SBOM tools
        run: |
          # Install CycloneDX
          npm install -g @cyclonedx/cyclonedx-npm
          
          # Install SPDX SBOM Generator
          wget https://github.com/opensbom-generator/spdx-sbom-generator/releases/download/v0.0.15/spdx-sbom-generator-v0.0.15-linux-amd64.tar.gz
          tar -xzf spdx-sbom-generator-v0.0.15-linux-amd64.tar.gz
          chmod +x spdx-sbom-generator
          sudo mv spdx-sbom-generator /usr/local/bin/

      - name: Generate CycloneDX SBOM
        run: |
          cyclonedx-npm --output-file cyclonedx-sbom.json
          echo "✅ CycloneDX SBOM generated"

      - name: Generate SPDX SBOM
        run: |
          spdx-sbom-generator -o spdx-sbom.json
          echo "✅ SPDX SBOM generated"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign CycloneDX SBOM with Cosign (keyless)
        if: github.event_name != 'pull_request'
        run: |
          cosign sign-blob --yes \
            --bundle cyclonedx-sbom.json.bundle \
            cyclonedx-sbom.json
          echo "✅ CycloneDX SBOM signed"

      - name: Sign SPDX SBOM with Cosign (keyless)
        if: github.event_name != 'pull_request'
        run: |
          cosign sign-blob --yes \
            --bundle spdx-sbom.json.bundle \
            spdx-sbom.json
          echo "✅ SPDX SBOM signed"

      - name: Verify CycloneDX SBOM signature
        if: github.event_name != 'pull_request'
        run: |
          cosign verify-blob \
            --bundle cyclonedx-sbom.json.bundle \
            --certificate-identity-regexp="^https://github.com/${{ github.repository_owner }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            cyclonedx-sbom.json
          echo "✅ CycloneDX SBOM signature verified"

      - name: Verify SPDX SBOM signature
        if: github.event_name != 'pull_request'
        run: |
          cosign verify-blob \
            --bundle spdx-sbom.json.bundle \
            --certificate-identity-regexp="^https://github.com/${{ github.repository_owner }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            spdx-sbom.json
          echo "✅ SPDX SBOM signature verified"

      - name: Upload CycloneDX SBOM
        uses: actions/upload-artifact@v4
        with:
          name: cyclonedx-sbom
          path: |
            cyclonedx-sbom.json
            cyclonedx-sbom.json.bundle
          retention-days: 90

      - name: Upload SPDX SBOM
        uses: actions/upload-artifact@v4
        with:
          name: spdx-sbom
          path: |
            spdx-sbom.json
            spdx-sbom.json.bundle
          retention-days: 90

      - name: Create summary
        run: |
          echo "## SBOM Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully generated and signed SBOM artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated SBOMs:" >> $GITHUB_STEP_SUMMARY
          echo "- **CycloneDX SBOM** (JSON)" >> $GITHUB_STEP_SUMMARY
          echo "- **SPDX SBOM** (JSON)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "### Signatures:" >> $GITHUB_STEP_SUMMARY
            echo "✅ All SBOMs signed with Cosign (keyless OIDC)" >> $GITHUB_STEP_SUMMARY
            echo "✅ All signatures verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Signature generation skipped for pull requests" >> $GITHUB_STEP_SUMMARY
          fi

  slsa-provenance:
    needs: generate-sbom
    if: github.event_name != 'pull_request'
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.9.0
    with:
      base64-subjects: "${{ needs.generate-sbom.outputs.hashes }}"
      upload-assets: true
